<!DOCTYPE html>
<html>
    <head>

        <meta charset="utf-8">
        <title>Template Loading D3</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>

    </head>
    <body>

        <h1>Bitcoin BTC</h1>

        <script type="text/javascript">

        var xhr = new XMLHttpRequest();

        function makeRequest(){
            xhr.open("GET", "https://api.coindesk.com/v1/bpi/historical/close.json?start=2010-07-17&end=2017-09-11", true);
            xhr.send();
            xhr.onreadystatechange = processRequest;
        }

        function processRequest(){
            console.log("testing, state: ", xhr.readyState)
            if(xhr.readyState == 4 && xhr.status == 200){
                let response = JSON.parse(xhr.responseText);
                makeChart(response);
            }
        }

        function makeChart(response){
            var w = 800;
            var h = 500;
            var padding = 40;

            // console.log(response);

            var parseDate = d3.time.format("%Y-%m-%d").parse;



            // var x = d3.time.scale().range([0, w]);
            // var y = d3.scale.linear().range([h, 0]);



            var makeDatesAndValues = function(input){
                console.log("insinde >>><><>< makeDates and tis is input", input)

                // Date.UTC(year, month[, day[, hour[, minute[, second[, millisecond]]]]])


                // var format = d3.time.format("%Y-%m-%d");
                // format.parse("2011-01-01");

                let dates = [];
                let values = [];
                let returnData = [];

                for(prop in input){
                    // console.log(prop)
                    dates.push(prop);
                    values.push(input[prop])
                }
                let counter = 0;
                let year = "";
                let month = "";
                let day = "";
                for( var i = 0; i < input.length; i++){
                    if(lastDate[i] !== "-" && counter == 0){
                        console.log("lastDate[i]", input[i])
                        year.push(input[i]);
                    } else if(input[i] == "-"){
                        counter++;
                    } else if(input[i] !== "-" && counter == 1){
                        month.push(input[i])
                    } else if(input[i] !== "-" && counter == 2){
                        day.push(input[i])
                    }
                }
                for(var i = 0; i < dates.length; i++){
                    // console.log("yyyEEAEEEEADEEEAOO: ", dates[i])
                    returnData.push({
                                        date: parseDate(dates[i]),
                                        value: values[i]
                                    })
                }
                console.log("TTTYYYYPPPEEE:", returnData);
                return returnData;
            }

            var lastDate = Object.keys(response.bpi)[Object.keys(response.bpi).length-1];
            var lastPrice = Object.values(response.bpi)[Object.values(response.bpi).length-1];
            // console.log(">>>>>>>>>", lastPrice);

            var counter = 0;
            var year = [];
            var month = [];
            var day = [];

            for( var i = 0; i < lastDate.length; i++){
                // console.log(lastDate)
                if(lastDate[i] !== "-" && counter == 0){
                    // console.log("lastDate[i]", lastDate[i])
                    year.push(lastDate[i]);
                } else if(lastDate[i] == "-"){
                    counter++;
                } else if(lastDate[i] !== "-" && counter == 1){
                    month.push(lastDate[i])
                } else if(lastDate[i] !== "-" && counter == 2){
                    day.push(lastDate[i])
                }
            }

            year = year.join("");
            month = month.join("");
            day = day.join("");

            // console.log(year, month, day)


            // var minDate = parseDate(2010, 7, 18)
            var minDate = new Date(2011-01-01)
            console.log(">>>>>>>>>>>", minDate)
            var maxDate = parseDate(year, month + 1, day)

            var fData = makeDatesAndValues(response.bpi);
            console.log("BBBBBOOOOOO", fData);


            var svg = d3.select("body")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);




            var x = d3.time.scale().range([0, w]);
            var y = d3.scale.linear().range([h, 0]);

            x.domain(d3.extent(fData, function(d) { return d.date; }));
            y.domain([0, d3.max(fData, function(d) { return d.value; })]);



            // var xScale = d3.time.scale()
            //                 .domain([minDate, maxDate])
            //                 // .range(padding, w - padding);
            //
            // var yScale = d3.scale.linear()
            //                 .domain([0, lastPrice])
            //                 // .range([h - padding, padding]);

            var xAxis = d3.svg.axis()
                            .scale(x)
                            .orient("bottom")
                            .ticks(5)

            var yAxis = d3.svg.axis()
                            .scale(y)
                            .orient("left");

            svg.selectAll("circle")
                            .data(fData)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d, i){
                                console.log("this is DDDDDATE>>>:",d)
                                return d.date;
                            })
                            .attr("cy", function(d, i){
                                return d.value
                            })
                            .attr("r", function(d){
                                return 5;
                            })
                            .attr("fill", "black")

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(300, " + (h - padding) + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(50, " + padding +")")
                .call(yAxis);

            makeDatesAndValues(response.bpi);
        }

        // var formatDate = function(input){
        //     var newFormat = [];
        //     console.log(input)
        //     for (prop in input.bpi){
        //         console.log("weerd")
        //     }
        //     return newFormat
        // }
        makeRequest();

        </script>

    </body>
</html>
