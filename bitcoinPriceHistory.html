<!DOCTYPE html>
<html>
    <head>

        <meta charset="utf-8">
        <title>Template Loading D3</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>

    </head>
    <body>

        <h1>Bitcoin BTC</h1>

        <script type="text/javascript">

        var xhr = new XMLHttpRequest();

        function makeRequest(){
            xhr.open("GET", "https://api.coindesk.com/v1/bpi/historical/close.json?start=2010-07-17&end=2017-09-11", true);
            xhr.send();
            xhr.onreadystatechange = processRequest;
        }

        function processRequest(){
            console.log("testing, state: ", xhr.readyState)
            if(xhr.readyState == 4 && xhr.status == 200){
                let response = JSON.parse(xhr.responseText);
                makeChart(response);
            }
        }

        function makeChart(response){
            var w = 800;
            var h = 500;
            var padding = 20;
            var Lpadding = 45;

            // var parseDate = d3.time.format("%Y-%m-%d").parse;
            console.log(response);

            var makeDatesAndValues = function(input){
                console.log("insinde >>><><>< makeDates and tis is input", input)

                let dates = [];
                let values = [];
                let returnData = [];

                for(prop in input){
                    values.push(input[prop])

                    let counter = 0;
                    let year = [];
                    let month = [];
                    let day = [];

                    for( var j = 0; j < prop.length; j++){
                        if(lastDate[j] !== "-" && counter == 0){
                            year.push(prop[j]);
                        } else if(prop[j] == "-"){
                            counter++;
                        } else if(prop[j] !== "-" && counter == 1){
                            month.push(prop[j])
                        } else if(prop[j] !== "-" && counter == 2){
                            day.push(prop[j])
                        }
                    }
                    // console.log("I DONT GET IT", month.join(""))
                    dates.push([Number(year.join("")), Number(month.join("")), Number(day.join(""))]);

                    returnData.push(
                        {
                                        date: [Number(year.join("")), Number(month.join("")), Number(day.join(""))],
                                        value: input[prop]
                        }
                    )
                }
                // console.log("YYYYYEEEEEHHHHAAAWWWW", returnData)
                return returnData;
            }

            var lastDate = Object.keys(response.bpi)[Object.keys(response.bpi).length-1];
            var lastPrice = Object.values(response.bpi)[Object.values(response.bpi).length-1];

            var inputData = makeDatesAndValues(response.bpi);

            var svg = d3.select("body")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);

            var y = d3.scale.linear()
                            .domain([0, 5000])
                            .range([h - padding, padding])


            var x = d3.time.scale()
                                .domain([new Date(2010, 7, 18), new Date(2017, 7, 18)])
                                .range([Lpadding, w]);

            // console.log("MIIIIIIRRRRRAAAAAAAAA.....:", x(new Date(2015, 0, 5)))

            var xAxis = d3.svg.axis()
                            .scale(x)
                            .orient("bottom")
                            .ticks(5)

            var yAxis = d3.svg.axis()
                            .scale(y)
                            .orient("left");

            svg.selectAll("circle")
                            .data(inputData)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d){
                                let thisDate = x(new Date(d.date[0], d.date[1], d.date[2]))
                                console.log("!!!!!!!!this TTTYYPIIEEE is DDDDDATE>>>:", thisDate);
                                return thisDate;
                            })
                            .attr("cy", function(d, i){
                                console.log("fffuuuuukkkkkk")
                                return d.value
                            })
                            .attr("r", function(d){
                                return 2;
                            })
                            .attr("fill", "black")

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0, " + (h - padding) + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + Lpadding + ", 0)")
                .call(yAxis);
        }

        makeRequest();

        </script>

    </body>
</html>
